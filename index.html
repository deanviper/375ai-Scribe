  <script>
    // ======== Category Switching Logic ========
    const categoryBtns = document.querySelectorAll('.category-btn');
    const yapSection    = document.getElementById('yap-section');
    const gamerSection  = document.getElementById('gamer-section');
    const scribeSection = document.getElementById('scribe-section');

    categoryBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        categoryBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        const target = btn.dataset.content;
        if (target === 'yap') {
          yapSection.classList.add('active');
          gamerSection.classList.remove('active');
          scribeSection.classList.remove('active');
        } else if (target === 'gamer') {
          yapSection.classList.remove('active');
          gamerSection.classList.add('active');
          scribeSection.classList.remove('active');
        } else if (target === 'scribe') {
          yapSection.classList.remove('active');
          gamerSection.classList.remove('active');
          scribeSection.classList.add('active');
        }
      });
    });

    // ======== YAP Leaderboard Script ========
    google.charts.load('current', { packages: ['table'] });

    let allUsers     = [];
    let pfpMap       = {};
    let isSearchView = false;

    google.charts.setOnLoadCallback(initYAP);

    function initYAP() {
      const SHEET_KEY = '1nE4NPgFSHka7ByLLKaHWaVaKARMCrmb-_e1ZvpdV-cE';
      fetchPFPs(SHEET_KEY).then(pfps => {
        pfpMap = pfps;
        loadScores(SHEET_KEY, pfpMap);
      });
      setupYAPEventListeners();
    }

    function setupYAPEventListeners() {
      const searchInput    = document.getElementById('search-input');
      const clearSearchBtn = document.getElementById('clear-search');
      const backButton     = document.getElementById('back-button');

      searchInput.addEventListener('input', handleSearch);
      clearSearchBtn.addEventListener('click', clearSearch);
      searchInput.addEventListener('input', () => {
        clearSearchBtn.style.display = searchInput.value ? 'block' : 'none';
      });

      backButton.addEventListener('click', () => {
        renderLeaderboard(allUsers.slice(0, 50), pfpMap);
        backButton.style.display = 'none';
        isSearchView = false;
      });
    }

    function fetchPFPs(key) {
      return new Promise(resolve => {
        const q = new google.visualization.Query(
          `https://docs.google.com/spreadsheets/d/${key}/gviz/tq?gid=0&headers=1&tq=select%20B%2C%20F`
        );
        q.send(res => {
          const dt = res.getDataTable(), map = {};
          for (let i = 0; i < dt.getNumberOfRows(); i++) {
            map[dt.getValue(i, 0)] = dt.getValue(i, 1);
          }
          resolve(map);
        });
      });
    }

    function loadScores(key, pfpMap) {
      const q = new google.visualization.Query(
        `https://docs.google.com/spreadsheets/d/${key}/gviz/tq?sheet=Temporary%20LB&headers=1&tq=select%20A%2C%20B%20order%20by%20B%20desc`
      );

      q.send(res => {
        const dt = res.getDataTable();
        allUsers = [];
        for (let i = 0; i < dt.getNumberOfRows(); i++) {
          allUsers.push({
            username: dt.getValue(i, 0),
            points:   dt.getValue(i, 1)
          });
        }

        // Render top-50
        renderLeaderboard(allUsers.slice(0, 50), pfpMap);
        document.getElementById('back-button').style.display = 'none';

        // Now fetch Meta!A1 for ‚ÄúLast Updated‚Äù
        const metaQuery = new google.visualization.Query(
          `https://docs.google.com/spreadsheets/d/${key}/gviz/tq?sheet=Meta&headers=1&tq=select%20A%20limit%201`
        );
        metaQuery.send(r2 => {
          const dt2 = r2.getDataTable();
          if (dt2.getNumberOfRows() > 0) {
            const ts = dt2.getValue(0, 0);
            document.getElementById('yap-updated').textContent = ts;
          }
        });
      });
    }

    function renderLeaderboard(users, pfpMap, searchTerm = '') {
      const tableDiv = document.getElementById('table_div');
      tableDiv.innerHTML = '';

      if (users.length === 0) {
        const noResults = document.createElement('div');
        noResults.className = 'no-results';
        noResults.innerHTML = `
          <i class="fas fa-search" style="font-size: 2rem; opacity: 0.5; margin-bottom: 1rem;"></i>
          <h3>No users found</h3>
          <p>Try searching with a different username</p>
        `;
        tableDiv.appendChild(noResults);
        return;
      }

      const table = document.createElement('table');
      const thead = table.createTHead();
      const headerRow = thead.insertRow();

      ['#', 'User', 'Points', ''].forEach(headerText => {
        const th = document.createElement('th');
        th.textContent = headerText;
        headerRow.appendChild(th);
      });

      const tbody = table.createTBody();

      users.forEach((user, index) => {
        const row = tbody.insertRow();
        row.style.opacity = '1'; // always visible

        const rankCell = row.insertCell();
        if (isSearchView) {
          for (let i = 0; i < allUsers.length; i++) {
            if (allUsers[i].username === user.username) {
              rankCell.textContent = i + 1;
              break;
            }
          }
        } else {
          rankCell.textContent = index + 1;
        }

        if ((isSearchView && rankCell.textContent === '1') || (!isSearchView && index === 0)) {
          rankCell.style.color = 'gold';
          rankCell.style.fontWeight = '700';
        } else if ((isSearchView && rankCell.textContent === '2') || (!isSearchView && index === 1)) {
          rankCell.style.color = 'silver';
          rankCell.style.fontWeight = '700';
        } else if ((isSearchView && rankCell.textContent === '3') || (!isSearchView && index === 2)) {
          rankCell.style.color = '#cd7f32';
          rankCell.style.fontWeight = '700';
        }

        const userCell = row.insertCell();
        userCell.className = 'username-cell';
        userCell.onclick = () => {
          window.open(`https://twitter.com/${user.username}`, '_blank');
          showToast(`Opening @${user.username}'s Twitter profile`);
        };

        const img = document.createElement('img');
        img.src = pfpMap[user.username] || 'https://via.placeholder.com/32';
        img.className = 'pfp';
        img.alt = `${user.username}'s profile`;
        img.onerror = function() {
          this.src = 'https://via.placeholder.com/32';
        };
        userCell.appendChild(img);

        const usernameSpan = document.createElement('span');
        usernameSpan.className = 'username-text';
        usernameSpan.textContent = user.username;
        userCell.appendChild(usernameSpan);

        const twitterIcon = document.createElement('i');
        twitterIcon.className = 'fab fa-twitter twitter-icon';
        userCell.appendChild(twitterIcon);

        if (searchTerm && user.username.toLowerCase().includes(searchTerm.toLowerCase())) {
          row.classList.add('highlighted');
        }

        const pointsCell = row.insertCell();
        pointsCell.className = 'points';
        pointsCell.textContent = user.points.toFixed(2);

        row.insertCell();
      });

      tableDiv.appendChild(table);
    }

    function handleSearch() {
      const searchInput = document.getElementById('search-input');
      const searchTerm  = searchInput.value.trim().toLowerCase();

      if (searchTerm === '') {
        renderLeaderboard(allUsers.slice(0, 50), pfpMap);
        document.getElementById('back-button').style.display = 'none';
        isSearchView = false;
        return;
      }

      const filteredUsers = allUsers.filter(user =>
        user.username.toLowerCase().includes(searchTerm)
      );

      renderLeaderboard(filteredUsers.slice(0, 20), pfpMap, searchTerm);

      document.getElementById('back-button').style.display = 'block';
      isSearchView = true;
    }

    function clearSearch() {
      document.getElementById('search-input').value = '';
      document.getElementById('clear-search').style.display = 'none';
      renderLeaderboard(allUsers.slice(0, 50), pfpMap);
      document.getElementById('back-button').style.display = 'none';
      isSearchView = false;
    }

    function showToast(message) {
      const toastContainer = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.innerHTML = `
        <i class="fas fa-external-link-alt toast-icon"></i>
        <span>${message}</span>
      `;
      toastContainer.appendChild(toast);
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    // ======== Gamer & Scribe Leaderboards Script ========
    let gamerData       = [];
    let rankedGamerData = [];
    let scribeData      = [];
    let rankedScribeData= [];

    function getGamerTier(points) {
      if (points >= 400) return { name: 'FAKER', class: 'faker-bg' };
      if (points >= 200) return { name: 'Gamer II', class: 'gamer2-bg' };
      return { name: 'Gamer I', class: 'gamer1-bg' };
    }

    function renderGamerLeaderboard(data, showTrueRank = false) {
      const tbody = document.querySelector('#gamer-leaderboard tbody');
      tbody.innerHTML = '';
      if (data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4" class="no-results">
          <div class="no-results-icon">üîç</div>
          No results
        </td></tr>`;
        return;
      }
      data.forEach((row, i) => {
        const tier = getGamerTier(row.points);
        let rankDisplay = '';
        if (showTrueRank) {
          const trueRank = rankedGamerData.findIndex(
            (r) => r.username === row.username && r.points === row.points
          ) + 1;
          if (trueRank === 1) rankDisplay = '<span class="medal">ü•á</span>';
          else if (trueRank === 2) rankDisplay = '<span class="medal">ü•à</span>';
          else if (trueRank === 3) rankDisplay = '<span class="medal">ü•â</span>';
          else rankDisplay = trueRank;
        } else {
          if (i === 0) rankDisplay = '<span class="medal">ü•á</span>';
          else if (i === 1) rankDisplay = '<span class="medal">ü•à</span>';
          else if (i === 2) rankDisplay = '<span class="medal">ü•â</span>';
          else rankDisplay = i + 1;
        }
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="rank">${rankDisplay}</td>
          <td>${row.username}</td>
          <td>${row.points}</td>
          <td class="${tier.class}">${tier.name}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function getScribeTier(points) {
      if (points >= 400) return { name: 'HEMMINGWAY', class: 'hem-bg' };
      if (points >= 150) return { name: 'Scribe 2', class: 'scribe2-bg' };
      return { name: 'Scribe 1', class: 'scribe1-bg' };
    }

    function renderScribeLeaderboard(data, showTrueRank = false) {
      const tbody = document.querySelector('#scribe-leaderboard tbody');
      tbody.innerHTML = '';
      if (data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4" class="no-results">
          <div class="no-results-icon">üîç</div>
          No results
        </td></tr>`;
        return;
      }
      data.forEach((row, i) => {
        const tier = getScribeTier(row.points);
        let rankDisplay = '';
        if (showTrueRank) {
          const trueRank = rankedScribeData.findIndex(
            (r) => r.username === row.username && r.points === row.points
          ) + 1;
          if (trueRank === 1) rankDisplay = '<span class="medal">ü•á</span>';
          else if (trueRank === 2) rankDisplay = '<span class="medal">ü•à</span>';
          else if (trueRank === 3) rankDisplay = '<span class="medal">ü•â</span>';
          else rankDisplay = trueRank;
        } else {
          if (i === 0) rankDisplay = '<span class="medal">ü•á</span>';
          else if (i === 1) rankDisplay = '<span class="medal">ü•à</span>';
          else if (i === 2) rankDisplay = '<span class="medal">ü•â</span>';
          else rankDisplay = i + 1;
        }
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="rank">${rankDisplay}</td>
          <td>${row.username}</td>
          <td>${row.points}</td>
          <td class="${tier.class}">${tier.name}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function fetchGamerData() {
      const query = new google.visualization.Query(
        'https://docs.google.com/spreadsheets/d/1-URTW-manGg0sCs0xbvLKhvLpy9ZXmiytUVOR5ZTCXw/gviz/tq?sheet=Leaderboard&tq=select%20A,B'
      );
      query.send(function (response) {
        if (response.isError()) {
          document.querySelector('#gamer-leaderboard tbody').innerHTML =
            '<tr><td colspan="4" style="color:var(--faker);text-align:center;">Failed to load leaderboard.</td></tr>';
          return;
        }
        const dataTable = response.getDataTable();
        gamerData = [];
        for (let i = 0; i < dataTable.getNumberOfRows(); i++) {
          gamerData.push({
            username: dataTable.getValue(i, 0),
            points:   parseInt(dataTable.getValue(i, 1), 10)
          });
        }
        rankedGamerData = [...gamerData].sort((a, b) => b.points - a.points);
        rankedGamerData.forEach((row, i) => (row.rank = i + 1));
        renderGamerLeaderboard(rankedGamerData);

        // Fetch Meta!A1
        const gamerMetaQuery = new google.visualization.Query(
          'https://docs.google.com/spreadsheets/d/1-URTW-manGg0sCs0xbvLKhvLpy9ZXmiytUVOR5ZTCXw/gviz/tq?sheet=Meta&headers=1&tq=select%20A%20limit%201'
        );
        gamerMetaQuery.send(resp => {
          const dt2 = resp.getDataTable();
          if (dt2.getNumberOfRows() > 0) {
            document.getElementById('gamer-updated').textContent = dt2.getValue(0, 0);
          }
        });
      });
    }

    function fetchScribeData() {
      const query = new google.visualization.Query(
        'https://docs.google.com/spreadsheets/d/18Ee6QihCWkklF8eX9QdwYuDRjLiKEAI9bHv3PvZAaNo/gviz/tq?sheet=Temporary%20LB&tq=select%20A,B'
      );
      query.send(function (response) {
        if (response.isError()) {
          document.querySelector('#scribe-leaderboard tbody').innerHTML =
            '<tr><td colspan="4" style="color:var(--hem);text-align:center;">Failed to load leaderboard.</td></tr>';
          return;
        }
        const dataTable = response.getDataTable();
        scribeData = [];
        for (let i = 0; i < dataTable.getNumberOfRows(); i++) {
          scribeData.push({
            username: dataTable.getValue(i, 0),
            points:   parseInt(dataTable.getValue(i, 1), 10)
          });
        }
        rankedScribeData = [...scribeData].sort((a, b) => b.points - a.points);
        rankedScribeData.forEach((row, i) => (row.rank = i + 1));
        renderScribeLeaderboard(rankedScribeData);

        // Fetch Meta!A1
        const scribeMetaQuery = new google.visualization.Query(
          'https://docs.google.com/spreadsheets/d/18Ee6QihCWkklF8eX9QdwYuDRjLiKEAI9bHv3PvZAaNo/gviz/tq?sheet=Meta&headers=1&tq=select%20A%20limit%201'
        );
        scribeMetaQuery.send(resp => {
          const dt2 = resp.getDataTable();
          if (dt2.getNumberOfRows() > 0) {
            document.getElementById('scribe-updated').textContent = dt2.getValue(0, 0);
          }
        });
      });
    }

    function initLeaderboards() {
      fetchGamerData();
      fetchScribeData();

      document.getElementById('gamer-search').addEventListener('input', function () {
        const val = this.value.trim().toLowerCase();
        if (!val) {
          renderGamerLeaderboard(rankedGamerData);
        } else {
          const filtered = rankedGamerData.filter(r => r.username.toLowerCase().includes(val));
          renderGamerLeaderboard(filtered, true);
        }
      });

      document.getElementById('scribe-search').addEventListener('input', function () {
        const val = this.value.trim().toLowerCase();
        if (!val) {
          renderScribeLeaderboard(rankedScribeData);
        } else {
          const filtered = rankedScribeData.filter(r => r.username.toLowerCase().includes(val));
          renderScribeLeaderboard(filtered, true);
        }
      });
    }

    google.charts.setOnLoadCallback(initLeaderboards);
  </script>
